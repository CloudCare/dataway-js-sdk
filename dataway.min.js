(function(global,factory){typeof exports==="object"&&typeof module!=="undefined"?module.exports=factory():typeof define==="function"&&define.amd?define(factory):global.dataway=factory()})(this,function(){"use strict";if(!CryptoJS){var CryptoJS=CryptoJS||function(Math,undefined){var create=Object.create||function(){function F(){}return function(obj){var subtype;F.prototype=obj;subtype=new F;F.prototype=null;return subtype}}();var C={};var C_lib=C.lib={};var Base=C_lib.Base=function(){return{extend:function(overrides){var subtype=create(this);if(overrides){subtype.mixIn(overrides)}if(!subtype.hasOwnProperty("init")||this.init===subtype.init){subtype.init=function(){subtype.$super.init.apply(this,arguments)}}subtype.init.prototype=subtype;subtype.$super=this;return subtype},create:function(){var instance=this.extend();instance.init.apply(instance,arguments);return instance},init:function(){},mixIn:function(properties){for(var propertyName in properties){if(properties.hasOwnProperty(propertyName)){this[propertyName]=properties[propertyName]}}if(properties.hasOwnProperty("toString")){this.toString=properties.toString}},clone:function(){return this.init.prototype.extend(this)}}}();var WordArray=C_lib.WordArray=Base.extend({init:function(words,sigBytes){words=this.words=words||[];if(sigBytes!=undefined){this.sigBytes=sigBytes}else{this.sigBytes=words.length*4}},toString:function(encoder){return(encoder||Hex).stringify(this)},concat:function(wordArray){var thisWords=this.words;var thatWords=wordArray.words;var thisSigBytes=this.sigBytes;var thatSigBytes=wordArray.sigBytes;this.clamp();if(thisSigBytes%4){for(var i=0;i<thatSigBytes;i++){var thatByte=thatWords[i>>>2]>>>24-i%4*8&255;thisWords[thisSigBytes+i>>>2]|=thatByte<<24-(thisSigBytes+i)%4*8}}else{for(var i=0;i<thatSigBytes;i+=4){thisWords[thisSigBytes+i>>>2]=thatWords[i>>>2]}}this.sigBytes+=thatSigBytes;return this},clamp:function(){var words=this.words;var sigBytes=this.sigBytes;words[sigBytes>>>2]&=4294967295<<32-sigBytes%4*8;words.length=Math.ceil(sigBytes/4)},clone:function(){var clone=Base.clone.call(this);clone.words=this.words.slice(0);return clone},random:function(nBytes){var words=[];var r=function(m_w){var m_w=m_w;var m_z=987654321;var mask=4294967295;return function(){m_z=36969*(m_z&65535)+(m_z>>16)&mask;m_w=18e3*(m_w&65535)+(m_w>>16)&mask;var result=(m_z<<16)+m_w&mask;result/=4294967296;result+=.5;return result*(Math.random()>.5?1:-1)}};for(var i=0,rcache;i<nBytes;i+=4){var _r=r((rcache||Math.random())*4294967296);rcache=_r()*987654071;words.push(_r()*4294967296|0)}return new WordArray.init(words,nBytes)}});var C_enc=C.enc={};var Hex=C_enc.Hex={stringify:function(wordArray){var words=wordArray.words;var sigBytes=wordArray.sigBytes;var hexChars=[];for(var i=0;i<sigBytes;i++){var bite=words[i>>>2]>>>24-i%4*8&255;hexChars.push((bite>>>4).toString(16));hexChars.push((bite&15).toString(16))}return hexChars.join("")},parse:function(hexStr){var hexStrLength=hexStr.length;var words=[];for(var i=0;i<hexStrLength;i+=2){words[i>>>3]|=parseInt(hexStr.substr(i,2),16)<<24-i%8*4}return new WordArray.init(words,hexStrLength/2)}};var Latin1=C_enc.Latin1={stringify:function(wordArray){var words=wordArray.words;var sigBytes=wordArray.sigBytes;var latin1Chars=[];for(var i=0;i<sigBytes;i++){var bite=words[i>>>2]>>>24-i%4*8&255;latin1Chars.push(String.fromCharCode(bite))}return latin1Chars.join("")},parse:function(latin1Str){var latin1StrLength=latin1Str.length;var words=[];for(var i=0;i<latin1StrLength;i++){words[i>>>2]|=(latin1Str.charCodeAt(i)&255)<<24-i%4*8}return new WordArray.init(words,latin1StrLength)}};var Utf8=C_enc.Utf8={stringify:function(wordArray){try{return decodeURIComponent(escape(Latin1.stringify(wordArray)))}catch(e){throw new Error("Malformed UTF-8 data")}},parse:function(utf8Str){return Latin1.parse(unescape(encodeURIComponent(utf8Str)))}};var BufferedBlockAlgorithm=C_lib.BufferedBlockAlgorithm=Base.extend({reset:function(){this._data=new WordArray.init;this._nDataBytes=0},_append:function(data){if(typeof data=="string"){data=Utf8.parse(data)}this._data.concat(data);this._nDataBytes+=data.sigBytes},_process:function(doFlush){var processedWords;var data=this._data;var dataWords=data.words;var dataSigBytes=data.sigBytes;var blockSize=this.blockSize;var blockSizeBytes=blockSize*4;var nBlocksReady=dataSigBytes/blockSizeBytes;if(doFlush){nBlocksReady=Math.ceil(nBlocksReady)}else{nBlocksReady=Math.max((nBlocksReady|0)-this._minBufferSize,0)}var nWordsReady=nBlocksReady*blockSize;var nBytesReady=Math.min(nWordsReady*4,dataSigBytes);if(nWordsReady){for(var offset=0;offset<nWordsReady;offset+=blockSize){this._doProcessBlock(dataWords,offset)}processedWords=dataWords.splice(0,nWordsReady);data.sigBytes-=nBytesReady}return new WordArray.init(processedWords,nBytesReady)},clone:function(){var clone=Base.clone.call(this);clone._data=this._data.clone();return clone},_minBufferSize:0});var Hasher=C_lib.Hasher=BufferedBlockAlgorithm.extend({cfg:Base.extend(),init:function(cfg){this.cfg=this.cfg.extend(cfg);this.reset()},reset:function(){BufferedBlockAlgorithm.reset.call(this);this._doReset()},update:function(messageUpdate){this._append(messageUpdate);this._process();return this},finalize:function(messageUpdate){if(messageUpdate){this._append(messageUpdate)}var hash=this._doFinalize();return hash},blockSize:512/32,_createHelper:function(hasher){return function(message,cfg){return new hasher.init(cfg).finalize(message)}},_createHmacHelper:function(hasher){return function(message,key){return new C_algo.HMAC.init(hasher,key).finalize(message)}}});var C_algo=C.algo={};return C}(Math);(function(Math){var C=CryptoJS;var C_lib=C.lib;var WordArray=C_lib.WordArray;var Hasher=C_lib.Hasher;var C_algo=C.algo;var T=[];(function(){for(var i=0;i<64;i++){T[i]=Math.abs(Math.sin(i+1))*4294967296|0}})();var MD5=C_algo.MD5=Hasher.extend({_doReset:function(){this._hash=new WordArray.init([1732584193,4023233417,2562383102,271733878])},_doProcessBlock:function(M,offset){for(var i=0;i<16;i++){var offset_i=offset+i;var M_offset_i=M[offset_i];M[offset_i]=(M_offset_i<<8|M_offset_i>>>24)&16711935|(M_offset_i<<24|M_offset_i>>>8)&4278255360}var H=this._hash.words;var M_offset_0=M[offset+0];var M_offset_1=M[offset+1];var M_offset_2=M[offset+2];var M_offset_3=M[offset+3];var M_offset_4=M[offset+4];var M_offset_5=M[offset+5];var M_offset_6=M[offset+6];var M_offset_7=M[offset+7];var M_offset_8=M[offset+8];var M_offset_9=M[offset+9];var M_offset_10=M[offset+10];var M_offset_11=M[offset+11];var M_offset_12=M[offset+12];var M_offset_13=M[offset+13];var M_offset_14=M[offset+14];var M_offset_15=M[offset+15];var a=H[0];var b=H[1];var c=H[2];var d=H[3];a=FF(a,b,c,d,M_offset_0,7,T[0]);d=FF(d,a,b,c,M_offset_1,12,T[1]);c=FF(c,d,a,b,M_offset_2,17,T[2]);b=FF(b,c,d,a,M_offset_3,22,T[3]);a=FF(a,b,c,d,M_offset_4,7,T[4]);d=FF(d,a,b,c,M_offset_5,12,T[5]);c=FF(c,d,a,b,M_offset_6,17,T[6]);b=FF(b,c,d,a,M_offset_7,22,T[7]);a=FF(a,b,c,d,M_offset_8,7,T[8]);d=FF(d,a,b,c,M_offset_9,12,T[9]);c=FF(c,d,a,b,M_offset_10,17,T[10]);b=FF(b,c,d,a,M_offset_11,22,T[11]);a=FF(a,b,c,d,M_offset_12,7,T[12]);d=FF(d,a,b,c,M_offset_13,12,T[13]);c=FF(c,d,a,b,M_offset_14,17,T[14]);b=FF(b,c,d,a,M_offset_15,22,T[15]);a=GG(a,b,c,d,M_offset_1,5,T[16]);d=GG(d,a,b,c,M_offset_6,9,T[17]);c=GG(c,d,a,b,M_offset_11,14,T[18]);b=GG(b,c,d,a,M_offset_0,20,T[19]);a=GG(a,b,c,d,M_offset_5,5,T[20]);d=GG(d,a,b,c,M_offset_10,9,T[21]);c=GG(c,d,a,b,M_offset_15,14,T[22]);b=GG(b,c,d,a,M_offset_4,20,T[23]);a=GG(a,b,c,d,M_offset_9,5,T[24]);d=GG(d,a,b,c,M_offset_14,9,T[25]);c=GG(c,d,a,b,M_offset_3,14,T[26]);b=GG(b,c,d,a,M_offset_8,20,T[27]);a=GG(a,b,c,d,M_offset_13,5,T[28]);d=GG(d,a,b,c,M_offset_2,9,T[29]);c=GG(c,d,a,b,M_offset_7,14,T[30]);b=GG(b,c,d,a,M_offset_12,20,T[31]);a=HH(a,b,c,d,M_offset_5,4,T[32]);d=HH(d,a,b,c,M_offset_8,11,T[33]);c=HH(c,d,a,b,M_offset_11,16,T[34]);b=HH(b,c,d,a,M_offset_14,23,T[35]);a=HH(a,b,c,d,M_offset_1,4,T[36]);d=HH(d,a,b,c,M_offset_4,11,T[37]);c=HH(c,d,a,b,M_offset_7,16,T[38]);b=HH(b,c,d,a,M_offset_10,23,T[39]);a=HH(a,b,c,d,M_offset_13,4,T[40]);d=HH(d,a,b,c,M_offset_0,11,T[41]);c=HH(c,d,a,b,M_offset_3,16,T[42]);b=HH(b,c,d,a,M_offset_6,23,T[43]);a=HH(a,b,c,d,M_offset_9,4,T[44]);d=HH(d,a,b,c,M_offset_12,11,T[45]);c=HH(c,d,a,b,M_offset_15,16,T[46]);b=HH(b,c,d,a,M_offset_2,23,T[47]);a=II(a,b,c,d,M_offset_0,6,T[48]);d=II(d,a,b,c,M_offset_7,10,T[49]);c=II(c,d,a,b,M_offset_14,15,T[50]);b=II(b,c,d,a,M_offset_5,21,T[51]);a=II(a,b,c,d,M_offset_12,6,T[52]);d=II(d,a,b,c,M_offset_3,10,T[53]);c=II(c,d,a,b,M_offset_10,15,T[54]);b=II(b,c,d,a,M_offset_1,21,T[55]);a=II(a,b,c,d,M_offset_8,6,T[56]);d=II(d,a,b,c,M_offset_15,10,T[57]);c=II(c,d,a,b,M_offset_6,15,T[58]);b=II(b,c,d,a,M_offset_13,21,T[59]);a=II(a,b,c,d,M_offset_4,6,T[60]);d=II(d,a,b,c,M_offset_11,10,T[61]);c=II(c,d,a,b,M_offset_2,15,T[62]);b=II(b,c,d,a,M_offset_9,21,T[63]);H[0]=H[0]+a|0;H[1]=H[1]+b|0;H[2]=H[2]+c|0;H[3]=H[3]+d|0},_doFinalize:function(){var data=this._data;var dataWords=data.words;var nBitsTotal=this._nDataBytes*8;var nBitsLeft=data.sigBytes*8;dataWords[nBitsLeft>>>5]|=128<<24-nBitsLeft%32;var nBitsTotalH=Math.floor(nBitsTotal/4294967296);var nBitsTotalL=nBitsTotal;dataWords[(nBitsLeft+64>>>9<<4)+15]=(nBitsTotalH<<8|nBitsTotalH>>>24)&16711935|(nBitsTotalH<<24|nBitsTotalH>>>8)&4278255360;dataWords[(nBitsLeft+64>>>9<<4)+14]=(nBitsTotalL<<8|nBitsTotalL>>>24)&16711935|(nBitsTotalL<<24|nBitsTotalL>>>8)&4278255360;data.sigBytes=(dataWords.length+1)*4;this._process();var hash=this._hash;var H=hash.words;for(var i=0;i<4;i++){var H_i=H[i];H[i]=(H_i<<8|H_i>>>24)&16711935|(H_i<<24|H_i>>>8)&4278255360}return hash},clone:function(){var clone=Hasher.clone.call(this);clone._hash=this._hash.clone();return clone}});function FF(a,b,c,d,x,s,t){var n=a+(b&c|~b&d)+x+t;return(n<<s|n>>>32-s)+b}function GG(a,b,c,d,x,s,t){var n=a+(b&d|c&~d)+x+t;return(n<<s|n>>>32-s)+b}function HH(a,b,c,d,x,s,t){var n=a+(b^c^d)+x+t;return(n<<s|n>>>32-s)+b}function II(a,b,c,d,x,s,t){var n=a+(c^(b|~d))+x+t;return(n<<s|n>>>32-s)+b}C.MD5=Hasher._createHelper(MD5);C.HmacMD5=Hasher._createHmacHelper(MD5)})(Math);(function(){var C=CryptoJS;var C_lib=C.lib;var WordArray=C_lib.WordArray;var Hasher=C_lib.Hasher;var C_algo=C.algo;var W=[];var SHA1=C_algo.SHA1=Hasher.extend({_doReset:function(){this._hash=new WordArray.init([1732584193,4023233417,2562383102,271733878,3285377520])},_doProcessBlock:function(M,offset){var H=this._hash.words;var a=H[0];var b=H[1];var c=H[2];var d=H[3];var e=H[4];for(var i=0;i<80;i++){if(i<16){W[i]=M[offset+i]|0}else{var n=W[i-3]^W[i-8]^W[i-14]^W[i-16];W[i]=n<<1|n>>>31}var t=(a<<5|a>>>27)+e+W[i];if(i<20){t+=(b&c|~b&d)+1518500249}else if(i<40){t+=(b^c^d)+1859775393}else if(i<60){t+=(b&c|b&d|c&d)-1894007588}else{t+=(b^c^d)-899497514}e=d;d=c;c=b<<30|b>>>2;b=a;a=t}H[0]=H[0]+a|0;H[1]=H[1]+b|0;H[2]=H[2]+c|0;H[3]=H[3]+d|0;H[4]=H[4]+e|0},_doFinalize:function(){var data=this._data;var dataWords=data.words;var nBitsTotal=this._nDataBytes*8;var nBitsLeft=data.sigBytes*8;dataWords[nBitsLeft>>>5]|=128<<24-nBitsLeft%32;dataWords[(nBitsLeft+64>>>9<<4)+14]=Math.floor(nBitsTotal/4294967296);dataWords[(nBitsLeft+64>>>9<<4)+15]=nBitsTotal;data.sigBytes=dataWords.length*4;this._process();return this._hash},clone:function(){var clone=Hasher.clone.call(this);clone._hash=this._hash.clone();return clone}});C.SHA1=Hasher._createHelper(SHA1);C.HmacSHA1=Hasher._createHmacHelper(SHA1)})();(function(){var C=CryptoJS;var C_lib=C.lib;var Base=C_lib.Base;var C_enc=C.enc;var Utf8=C_enc.Utf8;var C_algo=C.algo;var HMAC=C_algo.HMAC=Base.extend({init:function(hasher,key){hasher=this._hasher=new hasher.init;if(typeof key=="string"){key=Utf8.parse(key)}var hasherBlockSize=hasher.blockSize;var hasherBlockSizeBytes=hasherBlockSize*4;if(key.sigBytes>hasherBlockSizeBytes){key=hasher.finalize(key)}key.clamp();var oKey=this._oKey=key.clone();var iKey=this._iKey=key.clone();var oKeyWords=oKey.words;var iKeyWords=iKey.words;for(var i=0;i<hasherBlockSize;i++){oKeyWords[i]^=1549556828;iKeyWords[i]^=909522486}oKey.sigBytes=iKey.sigBytes=hasherBlockSizeBytes;this.reset()},reset:function(){var hasher=this._hasher;hasher.reset();hasher.update(this._iKey)},update:function(messageUpdate){this._hasher.update(messageUpdate);return this},finalize:function(messageUpdate){var hasher=this._hasher;var innerHash=hasher.finalize(messageUpdate);hasher.reset();var hmac=hasher.finalize(this._oKey.clone().concat(innerHash));return hmac}})})();(function(){var C=CryptoJS;var C_lib=C.lib;var WordArray=C_lib.WordArray;var C_enc=C.enc;var Base64=C_enc.Base64={stringify:function(wordArray){var words=wordArray.words;var sigBytes=wordArray.sigBytes;var map=this._map;wordArray.clamp();var base64Chars=[];for(var i=0;i<sigBytes;i+=3){var byte1=words[i>>>2]>>>24-i%4*8&255;var byte2=words[i+1>>>2]>>>24-(i+1)%4*8&255;var byte3=words[i+2>>>2]>>>24-(i+2)%4*8&255;var triplet=byte1<<16|byte2<<8|byte3;for(var j=0;j<4&&i+j*.75<sigBytes;j++){base64Chars.push(map.charAt(triplet>>>6*(3-j)&63))}}var paddingChar=map.charAt(64);if(paddingChar){while(base64Chars.length%4){base64Chars.push(paddingChar)}}return base64Chars.join("")},parse:function(base64Str){var base64StrLength=base64Str.length;var map=this._map;var reverseMap=this._reverseMap;if(!reverseMap){reverseMap=this._reverseMap=[];for(var j=0;j<map.length;j++){reverseMap[map.charCodeAt(j)]=j}}var paddingChar=map.charAt(64);if(paddingChar){var paddingIndex=base64Str.indexOf(paddingChar);if(paddingIndex!==-1){base64StrLength=paddingIndex}}return parseLoop(base64Str,base64StrLength,reverseMap)},_map:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/="};function parseLoop(base64Str,base64StrLength,reverseMap){var words=[];var nBytes=0;for(var i=0;i<base64StrLength;i++){if(i%4){var bits1=reverseMap[base64Str.charCodeAt(i-1)]<<i%4*2;var bits2=reverseMap[base64Str.charCodeAt(i)]>>>6-i%4*2;var bitsCombined=bits1|bits2;words[nBytes>>>2]|=bitsCombined<<24-nBytes%4*8;nBytes++}}return WordArray.create(words,nBytes)}})()}var isBrowser="undefined"===typeof XMLHttpRequest?false:true;var http,https;if(!isBrowser){http=require("http");https=require("https")}var MIN_ALLOWED_NS_TIMESTAMP="1000000000000000000";var ESCAPE_REPLACER="\\$1";var RE_ESCAPE_TAG_KEY=/([,= ])/g;var RE_ESCAPE_TAG_VALUE=RE_ESCAPE_TAG_KEY;var RE_ESCAPE_FIELD_KEY=RE_ESCAPE_TAG_KEY;var RE_ESCAPE_MEASUREMENT=/([, ])/g;var RE_ESCAPE_FIELD_STR_VALUE=/(["\\])/g;var ALERT_LEVELS=["critical","warning","info","ok"];function strf(){var args=Array.prototype.slice.call(arguments);if(0===args.length){return""}var pattern=args.shift();try{pattern=pattern.toString()}catch(ex){pattern=""}return pattern.replace(/\{(\d+)\}/g,function replaceFunc(m,i){return args[i]+""})}function parseQuery(query){if(query[0]==="?")query=query.slice(1);var queryObj={};query.split("&").forEach(function(kvExpr){var kvPair=kvExpr.split("=");queryObj[kvPair[0]]=kvPair[1]});return queryObj}function padLeft(str,char,length){while(str.length<length)str=char+str;return str}function padRight(str,char,length){while(str.length<length)str+=char;return str}function isObject(o){return Object.prototype.toString.call(o)==="[object Object]"}function isString(o){return"string"===typeof o}function isNumber(o){return"number"===typeof o}function isInteger(o){return isNumber(o)&&o%1===0}function isBoolean(o){return"boolean"===typeof o}function IntVal(i){this.val=parseInt(i)}function asInt(i){return new IntVal(i)}function stringifyTags(o){switch(Object.prototype.toString.call(o)){case"[object Object]":break;case"[object Array]":return JSON.stringify(o.map(stringifyTags));default:return JSON.stringify(o)}var keys=Object.keys(o);keys.sort();var parts=[];keys.forEach(function(k){parts.push(JSON.stringify(k)+":"+stringifyTags(o[k]))});return"{"+parts.join(",")+"}"}var ASSERT_TYPE_MAP={json:{type:"[object Object]",message:"should be a JSON object"},str:{type:"[object String]",message:"should be a String"}};function _assertType(data,dataType,name){var _dataType=Object.prototype.toString.call(data);if(_dataType!==ASSERT_TYPE_MAP[dataType].type){throw new Error(strf("`{0}` {1}, got {2}",name,ASSERT_TYPE_MAP[dataType].message,_dataType))}return data}function assertJSON(data,name){return _assertType(data,"json",name)}function assertStr(data,name){return _assertType(data,"str",name)}function assertTimestamp(data,name){if("number"!==typeof data&&!data.match(/^([1-9]\d+|\d)(\.\d*[1-9])?$/g)){throw new Error(strf("`{0}` should be a number or a number string, got {1}",name,data))}}function assertInt(data,name){if(!isInteger(data)){throw new Error(strf("`{0}` should be an number without point",name))}return data}function assertEnum(data,name,options){if(options.indexOf(data)<0){throw new Error(strf("`{0}` should be one of {1}",name,options.join(",")))}return data}function assertTags(data,name){assertJSON(data,name);for(var k in data)if(data.hasOwnProperty(k)){var v=data[k];assertStr(k,strf("Key of `{0}`: {1}",name));assertStr(v,strf('Value of `{0}["{1}"]`: {2}',name,k,v))}return data}function assertJSONStr(data,name){if("string"===typeof data){try{data=stringifyTags(JSON.parse(data))}catch(e){throw new Error(strf("`{0}` should be a JSON or JSON string",name))}}else if(isObject(data)){try{data=stringifyTags(data)}catch(e){throw new Error(strf("`{0}` should be a JSON or JSON string",name))}}else{throw new Error(strf("`{0}` should be a JSON or JSON string",name))}return data}function DataWay(options){this.CONTENT_TYPE="text/plain";this.METHOD="POST";options=options||{};this.host=options.host||"localhost";this.port=parseInt(options.port||9528);this.protocol=options.protocol||"http";this.path=options.path||"/v1/write/metrics";this.token=options.token;this.rp=options.rp||null;this.accessKey=options.accessKey;this.secretKey=options.secretKey;this.debug=options.debug||false;if(this.debug){if(isBrowser){console.log(strf("[JS Environment]\n{0}",navigator.userAgent))}else{console.log(strf("[JS Environment]\n node {0} {1} {2}",process.version,process.platform,process.arch))}}if(options.url){var parsedURL=new URL(options.url);this.protocol=parsedURL.protocol.replace(/\:$/g,"");if(parsedURL.pathname&&parsedURL.pathname!=="/"){this.path=parsedURL.pathname}if(parsedURL.search){var parsedQuery=parseQuery(parsedURL.search);if("token"in parsedQuery){this.token=parsedQuery.token}}this.host=parsedURL.hostname;if(parsedURL.port){this.port=parseInt(parsedURL.port)}else{this.port=this.protocol==="https"?443:80}}if(!this.token){throw new Error("`token` is required")}}DataWay.prototype._toNsString=function(timestamp){timestamp=timestamp.toString();if(timestamp.indexOf("e")>=0){var parts=timestamp.split("e");var tsI=parts[0].replace(/\./g,"");var tsP=parseInt(parts[1]);timestamp=strf("{0}{1}",tsI,tsP-tsI.length+1)}var parts=timestamp.split(".");var tsI=parts[0];var appending=padRight(parts[1]||"","0",9);for(var i=0;i<=9;i+=3){if(tsI.length+i>=MIN_ALLOWED_NS_TIMESTAMP.length){timestamp=strf("{0}{1}",tsI,appending.slice(0,i));break}}return timestamp};DataWay.prototype._getBodyMD5=function(body){var hash=CryptoJS.MD5(body);var md5Res=CryptoJS.enc.Base64.stringify(hash);return md5Res};DataWay.prototype._getSign=function(strToSign){var hash=CryptoJS.HmacSHA1(strToSign,this.secretKey);var md5Res=CryptoJS.enc.Base64.stringify(hash);return md5Res};DataWay.prototype._prepareHeaders=function(body){var headers={"Content-Type":this.CONTENT_TYPE};if(!this.accessKey||!this.secretKey){return headers}var bodyMD5=this._getBodyMD5(body);var dateStr=(new Date).toGMTString();var strToSign=[this.METHOD,bodyMD5,this.CONTENT_TYPE,dateStr].join("\n");var sign=this._getSign(strToSign);if(this.debug){console.log(strf("\n[String to sign] {0}",JSON.stringify(strToSign)));console.log(strf("[Signature] {0}",JSON.stringify(sign)))}headers["Date"]=dateStr;headers["Authorization"]=strf("DWAY {0}:{1}",this.accessKey,sign);return headers};DataWay.prototype._prepareBody=function(points){if(!Array.isArray(points))points=[points];var lines=[];points.forEach(function(p){var measurement=p.measurement;measurement=measurement.replace(RE_ESCAPE_MEASUREMENT,ESCAPE_REPLACER);var tagSetList=[];var tags=p.tags;if(tags){var keyList=Object.keys(tags).sort();keyList.forEach(function(k){var v=tags[k];if(!v)return;k=k.replace(RE_ESCAPE_TAG_KEY,ESCAPE_REPLACER);v=v.replace(RE_ESCAPE_TAG_VALUE,ESCAPE_REPLACER);tagSetList.push(strf("{0}={1}",k,v))})}var tagSet="";if(tagSetList.length>0){tagSet=strf(",{0}",tagSetList.join(","))}var fieldSetList=[];var fields=p.fields;if(fields){var keyList=Object.keys(fields).sort();keyList.forEach(function(k){var v=fields[k];if("undefined"===typeof v||v===null)return;k=k.replace(RE_ESCAPE_FIELD_KEY,ESCAPE_REPLACER);if(isString(v)){v=v.replace(RE_ESCAPE_FIELD_STR_VALUE,ESCAPE_REPLACER);v=strf('"{0}"',v)}else if(isBoolean(v)){v=strf("{0}",v)}else if(v instanceof IntVal){v=strf("{0}i",v.val)}else{v=strf("{0}",v)}fieldSetList.push(strf("{0}={1}",k,v))})}var fieldSet=strf(" {0}",fieldSetList.join(","));var timestamp=p.timestamp;timestamp=strf(" {0}",timestamp);lines.push(strf("{0}{1}{2}{3}",measurement,tagSet,fieldSet,timestamp))});var body=lines.join("\n");return body};DataWay.prototype._sendPoints=function(points,callback){var body=this._prepareBody(points);var headers=this._prepareHeaders(body);if(isBrowser){return this._sendPoints_browser(body,headers,callback)}else{return this._sendPoints_node(body,headers,callback)}};DataWay.prototype._sendPoints_browser=function(body,headers,callback){var self=this;var xhr=new XMLHttpRequest;var url=strf("{0}://{1}:{2}{3}?token={4}",self.protocol,self.host,self.port,self.path,self.token);if(self.rp){url+=strf("&rp={0}",self.rp)}if(this.debug){console.log(strf("[Request URL]\n{0}",url));console.log(strf("[Request Body]\n{0}",body))}xhr.open(self.METHOD,url);if(headers){for(var k in headers)if(headers.hasOwnProperty(k)){xhr.setRequestHeader(k,headers[k])}}var reqCallback=function(){var respData=xhr.responseText;try{respData=JSON.parse(respData)}catch(err){}var ret={statusCode:xhr.status,respData:respData};if(self.debug){console.log(strf("\n[Response Status Code] {0}",ret.statusCode));console.log(strf("[Response Body] {0}",JSON.stringify(ret.respData)))}if("function"===typeof callback)callback(null,ret)};xhr.onload=reqCallback;xhr.onerror=reqCallback;xhr.send(body)};DataWay.prototype._sendPoints_node=function(body,headers,callback){var self=this;var url=self.path+strf("?token={0}",self.token);if(self.rp){url+=strf("&rp={0}",self.rp)}if(this.debug){console.log(strf("[Request URL]\n{0}://{1}:{2}{3}",self.protocol,self.host,self.port,url));console.log(strf("[Request Body]\n{0}",body))}var requestOptions={host:self.host,port:self.port,path:url,method:self.METHOD,headers:headers,timeout:3*1e3};var httpLib=self.protocol==="https"?https:http;var respStatusCode=0;var respRawData="";var respData="";var req=httpLib.request(requestOptions,function(res){respStatusCode=res.statusCode;res.on("data",function(chunk){respRawData+=chunk});res.on("end",function(){respData=respRawData;try{respData=JSON.parse(respData)}catch(err){}var ret={statusCode:respStatusCode,respData:respData};if(self.debug){console.log(strf("\n[Response Status Code] {0}",ret.statusCode));console.log(strf("[Response Body] {0}",JSON.stringify(ret.respData)))}if("function"===typeof callback)return callback(null,ret)})});req.on("error",function(err){if("function"===typeof callback){return callback(err)}});if(body){req.write(body)}req.end()};DataWay.prototype._preparePoint=function(point){assertJSON(point,"point");var measurement=assertStr(point.measurement,"measurement");var tags=point.tags;if(tags){assertJSON(tags,"tags");assertTags(tags,"tags")}var fields=assertJSON(point.fields,"fields");var timestamp=point.timestamp;if(timestamp){assertTimestamp(timestamp,"timestamp")}else{timestamp=Date.now()}timestamp=this._toNsString(timestamp);var point={measurement:measurement,tags:tags||null,fields:fields||null,timestamp:timestamp};return point};DataWay.prototype.writePoint=function(data,callback){var point={measurement:data.measurement,tags:data.tags,fields:data.fields,timestamp:data.timestamp};var preparedPoint=this._preparePoint(point);this._sendPoints(preparedPoint,callback)};DataWay.prototype.writePoints=function(points,callback){var self=this;if(!Array.isArray(points)){throw new Error("`points` should be an array")}var preparedPoints=[];points.forEach(function(d){preparedPoints.push(self._preparePoint(d))});self._sendPoints(preparedPoints,callback)};DataWay.prototype._prepareKeyevent=function(keyevent){assertJSON(keyevent,"keyevent");var tags=keyevent.tags||{};assertTags(tags,"tags");var source=keyevent.source;if(source){tags.$source=assertStr(source,"source")}var fields={};fields.$title=assertStr(keyevent.title,"title");var des=keyevent.des;if(des){fields.$des=assertStr(des,"des")}var link=keyevent.link;if(link){assertStr(link,"link");if(link.toLowerCase().indexOf("http://")<0&&link.toLowerCase().indexOf("https://")<0||link.slice(-3)==="://"){throw new Error("`link` should be a valid URL with protocol")}fields.$link=link}var point={measurement:"$keyevent",tags:tags,fields:fields,timestamp:keyevent.timestamp};return this._preparePoint(point)};DataWay.prototype.writeKeyevent=function(data,callback){var keyevent={title:data.title,des:data.des,link:data.link,source:data.source,tags:data.tags,timestamp:data.timestamp};var preparedPoint=this._prepareKeyevent(keyevent);this._sendPoints(preparedPoint,callback)};DataWay.prototype.writeKeyevents=function(keyevents,callback){var self=this;if(!Array.isArray(keyevents)){throw new Error("`keyevents` should be an array")}var preparedPoints=[];keyevents.forEach(function(d){preparedPoints.push(self._prepareKeyevent(d))});self._sendPoints(preparedPoints,callback)};DataWay.prototype._prepareFlow=function(flow){assertJSON(flow,"flow");var tags=flow.tags||{};assertTags(tags,"tags");assertStr(flow.app,"app");tags.$traceId=assertStr(flow.traceId,"traceId");tags.$name=assertStr(flow.name,"name");var parent=flow.parent;if(parent){tags.$parent=assertStr(parent,"parent")}var fields=flow.fields||{};assertJSON(fields,"fields");var durationMs=flow.durationMs;if("number"===typeof durationMs){assertInt(durationMs,"durationMs")}var duration=flow.duration;if("number"===typeof duration){assertInt(duration,"duration")}if("number"===typeof duration){duration=duration*1e3}if("number"!==typeof durationMs&&"number"!==typeof duration){throw new Error("`duration` or `durationMs` is missing")}fields.$duration=asInt(durationMs||duration);var point={measurement:"$flow_"+flow.app,tags:tags,fields:fields,timestamp:flow.timestamp};return this._preparePoint(point)};DataWay.prototype.writeFlow=function(data,callback){var flow={app:data.app,traceId:data.traceId,name:data.name,duration:data.duration,durationMs:data.durationMs,parent:data.parent,fields:data.fields,tags:data.tags,timestamp:data.timestamp};var preparedPoint=this._prepareFlow(flow);this._sendPoints(preparedPoint,callback)};DataWay.prototype.writeFlows=function(flows,callback){var self=this;if(!Array.isArray(flows)){throw new Error("`flows` should be an array")}var preparedPoints=[];flows.forEach(function(d){preparedPoints.push(self._prepareFlow(d))});self._sendPoints(preparedPoints,callback)};DataWay.prototype._prepareAlert=function(alert){assertJSON(alert,"alert");var tags=alert.tags||{};assertTags(tags,"tags");tags.$level=assertEnum(alert.level,"level",ALERT_LEVELS);tags.$alertId=assertStr(alert.alertId,"alertId");var ruleId=alert.ruleId;if(ruleId){tags.$ruleId=assertStr(ruleId,"ruleId")}var noData=alert.noData;if(noData){tags.$noData="noData"}var alertItemTags=alert.alertItemTags;if(alertItemTags){assertTags(alertItemTags,"alertItemTags");for(var k in alertItemTags)if(alertItemTags.hasOwnProperty(k)){tags["$alertItem_"+k]=alertItemTags[k]}}var actionType=alert.actionType;if(actionType){tags.$actionType=assertStr(actionType,"actionType")}var fields={};var durationMs=alert.durationMs;if("number"===typeof durationMs){assertInt(durationMs,"durationMs")}var duration=alert.duration;if("number"===typeof duration){assertInt(duration,"duration")}if("number"===typeof duration){duration=duration*1e3}if("number"!==typeof durationMs&&"number"!==typeof duration){throw new Error("`duration` or `durationMs` is missing")}fields.$duration=asInt(durationMs||duration);fields.$checkValueJSON=assertJSONStr(alert.checkValue,"checkValue");var ruleName=alert.ruleName;if(ruleName){fields.$ruleName=assertStr(ruleName,"ruleName")}var actionContent=alert.actionContent;if(actionContent){fields.$actionContentJSON=assertJSONStr(actionContent,"checkValue")}var point={measurement:"$alert",tags:tags,fields:fields,timestamp:alert.timestamp};return this._preparePoint(point)};DataWay.prototype.writeAlert=function(data,callback){var alert={level:data.level,alertId:data.alertId,ruleId:data.ruleId,ruleName:data.ruleName,noData:data.noData,duration:data.duration,durationMs:data.durationMs,checkValue:data.checkValue,actionType:data.actionType,actionContent:data.actionContent,alertItemTags:data.alertItemTags,tags:data.tags,timestamp:data.timestamp};var preparedPoint=this._prepareAlert(alert);this._sendPoints(preparedPoint,callback)};DataWay.prototype.writeAlerts=function(alerts,callback){var self=this;if(!Array.isArray(alerts)){throw new Error("`alerts` should be an array")}var preparedPoints=[];alerts.forEach(function(d){preparedPoints.push(self._prepareAlert(d))});self._sendPoints(preparedPoints,callback)};return{DataWay:DataWay,Dataway:DataWay,asInt:asInt}});